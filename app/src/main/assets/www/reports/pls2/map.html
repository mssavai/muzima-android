<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/onsenui.css">
    <link rel="stylesheet" href="css/onsen-css-components.min.css">
    <link rel="stylesheet" href="css/chartjs/2.8.0/Chart.min.css">
    <link rel="stylesheet" href="css/material-design-iconic-font/css/material-design-iconic-font.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/materialize/1.0.0/materialize.min.css"  media="screen,projection"/>
    <script src="js/onsenui.min.js"></script>
    <script type="text/javascript" src="js/materialize/1.0.0/materialize.min.js"></script>
    <style>
        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #map {
            height: 100%;
        }
        .toolbarItem{
            font-size:0.8em;
        }
    </style>
</head>
<body>
<ons-splitter>
    <ons-splitter-side id="menu" side="left" width="220px" collapse swipeable>

        <ons-page>
            <ons-list>
                <ons-list-item tappable>
                    Report period:
                    <ons-list>
                        <ons-list-item onclick="loggingInterface.setCurrentReportPeriodAsDaily()" tappable>
                            <label class="left">
                                <ons-radio id="daily_visualization_period" name="visualization_period" input-id="daily"></ons-radio>
                            </label>
                            <label for="daily">
                                Show daily reports
                            </label>
                        </ons-list-item>
                        <ons-list-item onclick="loggingInterface.setCurrentReportPeriodAsWeekly()" tappable>
                            <label class="left">
                                <ons-radio id="weekly_visualization_period" name="visualization_period" input-id="weekly"></ons-radio>
                            </label>
                            <label for="weekly">
                                Show weekly reports
                            </label>
                        </ons-list-item>
                        <ons-list-item onclick="loggingInterface.setCurrentReportPeriodAsMonthly()" tappable>
                            <label class="left">
                                <ons-radio id="monthly_visualization_period" name="visualization_period" input-id="monthly"></ons-radio>
                            </label>
                            <label for="monthly" class="center">
                                Show monthly reports
                            </label>
                        </ons-list-item>
                    </ons-list>
                </ons-list-item>
                <ons-list-item id="providerSelection">
                    Select Providers:
                    <ons-list id="providerList">

                    </ons-list>
                </ons-list-item>
                <ons-list-item onclick="loggingInterface.navigateToPage('settings.html')" tappable>
                    <ons-icon modifier="cta" icon="md-settings"></ons-icon> &nbsp;&nbsp;&nbsp;&nbsp;Settings
                </ons-list-item>
                <ons-list-item onclick="loggingInterface.navigateToPage('about.html')" tappable>
                    <ons-icon modifier="cta" icon="md-help"></ons-icon> &nbsp;&nbsp;&nbsp;&nbsp;Help
                </ons-list-item>
            </ons-list>
        </ons-page>
    </ons-splitter-side>
    <ons-splitter-content id="content" >
        <ons-navigator id="onsnavigator">
        <ons-page>
            <ons-toolbar class="mytoolbar">
                <div class="left">
                    <ons-toolbar-button class="toolbarItem" onclick="loggingInterface.decrementReportPeriodOffset()">
                        <ons-icon icon="md-chevron-left"></ons-icon>
                        <ons-icon icon="md-chevron-left"></ons-icon>
                    </ons-toolbar-button>
                    <span class="reportPeriodLabel toolbarItem"></span>
                    <ons-toolbar-button class="incrementReportPeriodButton toolbarItem" onclick="loggingInterface.incrementReportPeriodOffset()">
                        <ons-icon icon="md-chevron-right"></ons-icon>
                        <ons-icon icon="md-chevron-right"></ons-icon>
                    </ons-toolbar-button>
                </div>
                <div class="right">
                    <ons-toolbar-button class="toolbarItem"  onclick="openMenu()">
                        <ons-icon icon="md-menu"></ons-icon>
                    </ons-toolbar-button>
                </div>
            </ons-toolbar>

            <div id="map"></div>
        </ons-page>
        </ons-navigator>
    </ons-splitter-content>

</ons-splitter>
<script>

    var map;

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 7,
            center: new google.maps.LatLng(-0.10221,34.76171),
        });

        var labels = getChartDataDates();
        var mapData = loggingInterface.getMapData();
        var markers = [];

        mapData = JSON.parse(mapData);

        for (var k in mapData) {
            var v = mapData[k];
            if (isProviderSelected(v.id)){
                labels.forEach(function (label) {
                    if (v.data[label] != undefined) {
                        var providerMapData = v.data[label];
                        var m = providerMapData.map(function(location, j) {
                            var marker =  new google.maps.Marker({
                                position: {lat:location.lat, lng:location.lng},
                                label: v.full_name.charAt(0)
                            });

                            var contentString = "<div>" +
                                "<p>Provider: " + v.full_name + "</p>" +
                                "<p>Encounter date : " + location.encounter_date + "</p>" +
                                "</div>";

                            var infowindow = new google.maps.InfoWindow({
                                content: contentString
                            });

                            marker.addListener('click', function() {
                                infowindow.open(map, marker);
                            });

                            return marker;
                        });
                        markers = markers.concat(m);

                    }

                });
            }
        };

        var markerCluster = new MarkerClusterer(map, markers,
            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});

    }
</script>
<script>
    const openMenu = function() {
        var menu = document.getElementById('menu');
        menu.open();
    };


    const refreshReportPeriodDisplayString = function(){
        var reportPeriodString = loggingInterface.getReportPeriodDisplayString();
        var labels = document.getElementsByClassName('reportPeriodLabel');
        for (i = 0; i < labels.length; i++) {
            labels[i].innerHTML = reportPeriodString;
        }

        var buttons = document.getElementsByClassName('incrementReportPeriodButton');
        if(loggingInterface.getReportPeriodOffset() == 0){
            for (i = 0; i < buttons.length; i++) {
                buttons[i].setAttribute("disabled","disabled");
            }
        } else {
            for (i = 0; i < buttons.length; i++) {
                buttons[i].removeAttribute("disabled");
            }
        }
    }


    document.loadPage = function(pageToLoad)
    {
        var navigator = document.querySelector('#onsnavigator');
        if (pageToLoad != null && pageToLoad != '') {
            navigator.resetToPage(pageToLoad);
        }

        var sideMenuElement = document.getElementById("menu");
        if(pageToLoad == "login.html"){
            if(sideMenuElement.hasAttribute("swipeable")){
                sideMenuElement.removeAttribute("swipeable");
            }
        } else if(!sideMenuElement.hasAttribute("swipeable")){
            sideMenuElement.setAttribute("swipeable");
        }

        if(document.querySelector('ons-splitter-side').isOpen) {
            document.querySelector('ons-splitter-side').close();
        }
    }
    document.querySelector('ons-splitter-side').addEventListener('postclose', function() {
        console.log("Reloading.......");
        loggingInterface.reloadCurrentPage();
    })

    var savedSelectedProviderJsonString = loggingInterface.getSelectedProviders();
    console.log("savedSelectedProviderJsonString");
    console.log(savedSelectedProviderJsonString);
    const selectedProviders = JSON.parse(savedSelectedProviderJsonString);
    const toggleSelectedProvider = function(value){
        var index = selectedProviders.indexOf(value);
        if(index > -1){
            selectedProviders.splice(index,1);
        } else {
            selectedProviders.push(value);
        }
        loggingInterface.saveSelectedProviders(JSON.stringify(selectedProviders));
    }
    const addSelectedProvider = function(value){
        var index = selectedProviders.indexOf(value);
        if(index == -1){
            selectedProviders.push(value);
            loggingInterface.saveSelectedProviders(JSON.stringify(selectedProviders));
        }
    }
    const isProviderSelected = function(value){
        return selectedProviders.indexOf(value) > -1;
    }

    const getChartData = function(chartType){
        var chartData = loggingInterface.getChartData(chartType);
        chartData = JSON.parse(chartData);

        return chartData;
    }

    const getChartDataDates = function(){
        var dates = loggingInterface.getChartDataDates();
        return JSON.parse(dates);
    }

    var systemStatistics = ["average","expected"];

    var providerSelectorElement = document.getElementById("providerSelection");

    var isSupervisor = loggingInterface.isCurrentUserSupervisor();
    var providerListSelectionHtml = "";
    var providers = loggingInterface.getProviders();
    providers = JSON.parse(providers);
    providers.forEach(function(provider){
        if(systemStatistics.indexOf(provider.id) > -1){
            addSelectedProvider(provider.id);
        } else {
            if (isSupervisor){
                var checked = isProviderSelected(provider.id)  ? "checked" : "";
                if (checked === "checked") {
                    addSelectedProvider(provider.id);
                }
                providerListSelectionHtml += "<ons-list-item tappable>\n" +
                    "<label class=\"left\">\n" +

                    "<ons-checkbox " + checked + " name=\"provider\"" +
                    " onchange=\"toggleSelectedProvider('" + provider.id + "')\"" +
                    " input-id=\"" + provider.id + "\"" +
                    "></ons-checkbox>" +
                    provider.full_name + " (" + provider.id + ")" +
                    "</label>" +
                    "</ons-list-item>";
            } else if(provider.isLoggedIn === "true") {
                addSelectedProvider(provider.id);
            }
        }
    });

    if(!isSupervisor){
        providerSelectorElement.style.display = 'none';
    }

    var providerListElement = document.getElementById("providerList");
    providerListElement.innerHTML = providerListSelectionHtml;
    providerSelectorElement.style.display = 'show';

    refreshReportPeriodDisplayString();

    if(loggingInterface.isCurrentReportPeriodMonthly()){
        var monthlyReportPeriodOption = document.getElementById("monthly_visualization_period");
        monthlyReportPeriodOption.checked = true;
    } else if(loggingInterface.isCurrentReportPeriodDaily()){
        var monthlyReportPeriodOption = document.getElementById("daily_visualization_period");
        monthlyReportPeriodOption.checked = true;
    } else {
        var weeklyReportPeriodOption = document.getElementById("weekly_visualization_period");
        weeklyReportPeriodOption.checked = true;
    }

</script>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBy41-d7Btm50DYUd9fNuUy7tzIPzGZRBg&callback=initMap">
</script>
</body>
</html>