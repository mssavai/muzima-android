<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/onsenui/2.10.8/onsenui.min.css">
    <link rel="stylesheet" href="css/onsenui/2.10.8/onsen-css-components.min.css">
    <link rel="stylesheet" href="css/material-design-iconic-font/css/material-design-iconic-font.min.css"/>
    <link type="text/css" rel="stylesheet" href="css/materialize/1.0.0/materialize.min.css"  media="screen,projection"/>
    <script src="js/onsenui/2.10.8/onsenui.min.js"></script>
    <script type="text/javascript" src="js/materialize/1.0.0/materialize.min.js"></script>
</head>
<body>
<ons-splitter>

    <ons-splitter-side id="menu" side="left" width="220px" collapse swipeable>

        <ons-page>
            <ons-list>
                <ons-list-item tappable>
                    <b style="text-align: left">Choose report period:</b>
                    <ons-list>
                        <ons-list-item onclick="setCurrentReportPeriodAsDaily()" tappable>
                            <label class="left">
                                <ons-radio id="daily_visualization_period" name="visualization_period" input-id="daily"></ons-radio>
                            </label>
                            <label for="daily">
                                <b>Show daily reports</b>
                            </label>
                        </ons-list-item>
                        <ons-list-item onclick="setCurrentReportPeriodAsWeekly()" tappable>
                            <label class="left">
                                <ons-radio id="weekly_visualization_period" name="visualization_period" input-id="weekly"></ons-radio>
                            </label>
                            <label for="weekly">
                                <b>Show weekly reports</b>
                            </label>
                        </ons-list-item>
                        <ons-list-item onclick="setCurrentReportPeriodAsMonthly()" tappable>
                            <label class="left">
                                <ons-radio id="monthly_visualization_period" name="visualization_period" input-id="monthly"></ons-radio>
                            </label>
                            <label for="monthly" class="center">
                                <b>Show monthly reports</b>
                            </label>
                        </ons-list-item>
                    </ons-list>
                </ons-list-item>
                <ons-list-item id="providerSelection">
                    <b style="text-align: left">Select providers to show reports:</b>
                    <ons-list id="providerList">

                    </ons-list>
                </ons-list-item>
                <ons-list-item onclick="loggingInterface.navigateToPage('settings.html')" tappable>
                    <b style="text-align: left">Expected performance settings</b>
                </ons-list-item>
                <ons-list-item onclick="loggingInterface.navigateToPage('about.html')" tappable>
                    <b style="text-align: left">Help</b>
                </ons-list-item>
            </ons-list>
        </ons-page>
    </ons-splitter-side>
    <ons-splitter-content>
        <ons-navigator id="onsnavigator">
        <ons-page>
            <ons-toolbar class="mytoolbar">
                <div class="left">
                    <ons-toolbar-button class="toolbarItem" onclick="loggingInterface.decrementReportPeriodOffset()">
                        <ons-icon icon="md-chevron-left"></ons-icon>
                        <ons-icon icon="md-chevron-left"></ons-icon>
                    </ons-toolbar-button>
                    <span class="reportPeriodLabel toolbarItem"></span>
                    <ons-toolbar-button class="incrementReportPeriodButton toolbarItem" onclick="loggingInterface.incrementReportPeriodOffset()">
                        <ons-icon icon="md-chevron-right"></ons-icon>
                        <ons-icon icon="md-chevron-right"></ons-icon>
                    </ons-toolbar-button>
                </div>
                <div class="right">
                    <ons-toolbar-button class="toolbarItem"  onclick="openMenu()">
                        <ons-icon icon="md-menu"></ons-icon>
                    </ons-toolbar-button>
                </div>
            </ons-toolbar>

            <div id="map"></div>
        </ons-page>
        </ons-navigator>
    </ons-splitter-content>

</ons-splitter>
<script src="js/common.js"></script>

<script>
    refreshReportPeriodDisplayString();

    if(loggingInterface.isCurrentReportPeriodMonthly()){
        var monthlyReportPeriodOption = document.getElementById("monthly_visualization_period");
        monthlyReportPeriodOption.checked = true;
    } else if(loggingInterface.isCurrentReportPeriodDaily()){
        var monthlyReportPeriodOption = document.getElementById("daily_visualization_period");
        monthlyReportPeriodOption.checked = true;
    } else {
        var weeklyReportPeriodOption = document.getElementById("weekly_visualization_period");
        weeklyReportPeriodOption.checked = true;
    }

</script>

<script>

    var map;
    var mapRendered = false;

    function initMap() {
        console.log("Attempt Init map...");
        if(!mapRendered) {
            console.log("Init map...");
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 7,
                center: new google.maps.LatLng(-0.10221, 34.76171),
            });

            var labels = getChartDataDates();
            var mapData = loggingInterface.getMapData();
            var markers = [];

            mapData = JSON.parse(mapData);

            for (var k in mapData) {
                var v = mapData[k];
                if (isProviderSelected(v.id)) {
                    labels.forEach(function (label) {
                        if (v.data[label] != undefined) {
                            var providerMapData = v.data[label];
                            var m = providerMapData.map(function (location, j) {
                                var marker = new google.maps.Marker({
                                    position: {lat: location.lat, lng: location.lng},
                                    label: v.full_name.charAt(0)
                                });

                                var contentString = "<div>" +
                                    "<p>Provider: " + v.full_name + "</p>" +
                                    "<p>Encounter date : " + location.encounter_date + "</p>" +
                                    "</div>";

                                var infowindow = new google.maps.InfoWindow({
                                    content: contentString
                                });

                                marker.addListener('click', function () {
                                    infowindow.open(map, marker);
                                });

                                return marker;
                            });
                            markers = markers.concat(m);

                        }

                    });
                }
            }
            ;

            var markerCluster = new MarkerClusterer(map, markers,
                {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});

            mapRendered = true;
        }
    }
</script>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBy41-d7Btm50DYUd9fNuUy7tzIPzGZRBg&callback=initMap">
</script>
</body>
</html>